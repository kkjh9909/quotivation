<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link th:href="@{/css/main.css}" rel="stylesheet" />
    <title th:text="${quote.content}">Document</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript" th:inline="javascript">
        function clickLikeButton() {
			const likeIcon = document.querySelector('#likeButton i.material-icons').textContent.trim();

			if (likeIcon === "thumb_up") {
				unlikeQuote();
			}
            else {
				likeQuote();
			}
		}

		function clickDislikeButton() {
			const likeIcon = document.querySelector('#dislikeButton i.material-icons').textContent.trim();

			if (likeIcon === "thumb_down") {
				unDislikeQuote();
			}
			else {
				dislikeQuote();
			}
        }

        function likeQuote() {
			const quoteId = window.location.pathname.split("/").pop();

			fetch(`/user/quote/like/${quoteId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({}),
			})
            .then(response => {
				if(response.status === 401) {
					const result = window.confirm("로그인이 필요합니다.\n로그인 하시겠습니까?");

					if(result)
						location.href='/login'
                    else
						return Promise.reject('로그인 취소');
                }
				return response.text()
			})
            .then(html => {
                const likeButtonElement = document.querySelector('#likeButton');
                likeButtonElement.outerHTML = html;
            })
            .catch(error => {
				if (error !== '로그인 취소') {
					console.error('Error:', error);
				}
            });
        }

		function unlikeQuote() {
			const quoteId = window.location.pathname.split("/").pop();

			fetch(`/user/quote/like/${quoteId}`, {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({}),
			})
				.then(response => {
					if(response.status === 401) {
						const result = window.confirm("로그인이 필요합니다.\n로그인 하시겠습니까?");

						if(result)
							location.href='/login'
						else
							return Promise.reject('로그인 취소');
					}
					return response.text()
				})
				.then(html => {
					const likeButtonElement = document.querySelector('#likeButton');
					likeButtonElement.outerHTML = html;
				})
				.catch(error => {
					if (error !== '로그인 취소') {
						console.error('Error:', error);
					}
				});
		}

		function dislikeQuote() {
			const quoteId = window.location.pathname.split("/").pop();

			fetch(`/user/quote/dislike/${quoteId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({}),
			})
				.then(response => {
					if(response.status === 401) {
						const result = window.confirm("로그인이 필요합니다.\n로그인 하시겠습니까?");

						if(result)
							location.href='/login'
						else
							return Promise.reject('로그인 취소');
					}
					return response.text()
				})
				.then(html => {
					const likeButtonElement = document.querySelector('#dislikeButton');
					likeButtonElement.outerHTML = html;
				})
				.catch(error => {
					if (error !== '로그인 취소') {
						console.error('Error:', error);
					}
				});
		}

		function unDislikeQuote() {
			const quoteId = window.location.pathname.split("/").pop();

			fetch(`/user/quote/dislike/${quoteId}`, {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({}),
			})
				.then(response => {
					if(response.status === 401) {
						const result = window.confirm("로그인이 필요합니다.\n로그인 하시겠습니까?");

						if(result)
							location.href='/login'
						else
							return Promise.reject('로그인 취소');
					}
					return response.text()
				})
				.then(html => {
					const likeButtonElement = document.querySelector('#dislikeButton');
					likeButtonElement.outerHTML = html;
				})
				.catch(error => {
					if (error !== '로그인 취소') {
						console.error('Error:', error);
					}
				});
		}

		function clickSubscriptionButton() {
			const subscribeIcon = document.querySelector('#subscribeButton i.material-icons').textContent.trim();

			if (subscribeIcon === "star") {
				unsubscribeAuthor();
			}
			else {
				subscribeAuthor();
			}
        }

		function subscribeAuthor() {
			const quoteId = window.location.pathname.split('/')[2];

			fetch(`/user/quote/subscribe/${quoteId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({}),
			})
				.then(response => {
					if(response.status === 401) {
						const result = window.confirm("로그인이 필요합니다.\n로그인 하시겠습니까?");

						if(result)
							location.href='/login'
						else
							return Promise.reject('로그인 취소');
					}
					return response.text()
				})
				.then(html => {
					const likeButtonElement = document.querySelector('#subscribeButton');
					likeButtonElement.outerHTML = html;
				})
				.catch(error => {
					if (error !== '로그인 취소') {
						console.error('Error:', error);
					}
				});
		}

		function unsubscribeAuthor() {
			const quoteId = window.location.pathname.split('/')[2];

			fetch(`/user/quote/subscribe/${quoteId}`, {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({}),
			})
				.then(response => {
					if(response.status === 401) {
						const result = window.confirm("로그인이 필요합니다.\n로그인 하시겠습니까?");

						if(result)
							location.href='/login'
						else
							return Promise.reject('로그인 취소');
					}
					return response.text()
				})
				.then(html => {
					const likeButtonElement = document.querySelector('#subscribeButton');
					likeButtonElement.outerHTML = html;
				})
				.catch(error => {
					if (error !== '로그인 취소') {
						console.error('Error:', error);
					}
				});
		}
    </script>
    <style>
        .col.position-relative {
            position: relative;
        }

        .centered {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .bottom-right {
            position: absolute;
            bottom: 0;
            right: 0;
            margin: 10px;
        }
        .centered-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%; /* 부모 요소의 높이를 설정 */
        }
    </style>
    <meta name="google-site-verification" content="dfCocKxAKm02TrZOrhOi6yjgM0vE3qvZ-l2NF0F4Orc" />
</head>
<body>
<div th:insert="~{fragments/header :: header}"></div>
<div class="container">
    <div class="row">
        <div class="col">
            <input class="form-control me-2" type="search" placeholder="검색" aria-label="Search" id="word">
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-success" th:onclick="searchQuote()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                </svg>
            </button>
        </div>
    </div>
    <hr>
    <div class="container">
        <div class="row bg-success p-2 text-dark bg-opacity-25">
            <div class="col-3">
                <img th:src="${quote.photo}" alt="이미지" class="img-fluid w-100">
                <div class="text-center mt-3">
                    <h4 th:text="'-' + ${quote.author} + '-'">저자</h4>
                </div>
            </div>
            <div class="col position-relative">
                <div id="subscribeButton" class="text-end">
                    <button class="btn" onclick="clickSubscriptionButton()">
                        <i class="material-icons"
                           th:switch="${isSubscribe}">
                            <span th:case="true">star</span> <!-- 채워진 별 -->
                            <span th:case="false">star_border</span>
                        </i>
                    </button>
                </div>
                <p th:text="${quote.content}" class="centered quote-content"></p>
                <div class="bottom-right">
                    <div class="row">
                        <div id="likeButton" class="col">
                            <button class="btn" onclick="clickLikeButton()">
                                <i class="material-icons"
                                   th:switch="${isLike}">
                                    <span th:case="true">thumb_up</span> <!-- 채워짐 -->
                                    <span th:case="false">thumb_up_off_alt</span>
                                </i>
                                <b th:id="likeCount" id="likeCount" th:text="${likeCount}">0</b>
                            </button>
                        </div>
                        <div id="dislikeButton" class="col">
                            <button class="btn" onclick="clickDislikeButton()">
                                <i class="material-icons"
                                   th:switch="${isDislike}">
                                    <span th:case="true">thumb_down</span>
                                    <span th:case="false">thumb_down_off_alt</span>
                                </i>
                                <b th:id="dislikeCount" id="dislikeCount" th:text="${dislikeCount}">0</b>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="row align-items-stretch">
        <div class="col-3" th:each="relatedQuote: ${relatedQuotes}">
            <div class="card">
                <img th:src="${relatedQuote.photo}" class="card-img-top" alt="author">
                <div class="card-body">
                    <p class="card-text simply-text" th:text="${relatedQuote.content}"></p>
                    <div class="text-end">
                        <p class="card-text simply-text" th:text="'-' + ${relatedQuote.author} + '-'"></p>
                    </div>
                    <div class="text-center">
                        <a th:href="@{'/quote/' + ${relatedQuote.id}}" class="btn btn-primary">바로가기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
</body>
<div th:insert="~{fragments/footer :: footer}"></div>
</html>